# Proposal 002: Node Authentication

This feature will add **Node Authentication**:

This proposal only considers **identity** in the context of **membership**, not
authorization.

A summary of the authentication pattern is as follows:

* An aurae node is a self-contained runtime environment.
* An operator is an entity that controls an aurae node.
* The aurae node acts as an automated agent for the operator.
* The operator may choose to link the node to an OIDC identity through a
  successful challenge.

### Proposal
All authentication with the aurae daemon will use "SSH Certificates". SSH
Certificates are standard SSH keys that are also signed by an x509 certificate.

Both server and client will be required to use signed SSH certificates.

#### Bootstrapping in Detached Mode
In detached mode, a CA will be generated by auraed. During initialization, a
URL may be specified containing known SSH keys for bootstrapping purposes. The
URL must be an encrypted endpoint with the URL's CA in the client's keystore.

A common candidate will be GitHub's keys URL.

E.g. https://github.com/taniwha3.keys

The operator may connect to auraed using the preconfigured SSH key and
establish a new set of SSH Certificate credentials.

Regardless of where the certificate is signed, the SSH-key component must be
generated at the client or by an authorized device. The aurae daemon shall not
generate client SSH keys, but may be involved with signing keys.

### Example Use Cases

#### Detached Mode
At its simplest, the operator should be able to instantiate auraed without any
federation capabilities. This is useful for small one-off nodes, development,
and air-gapped environments. A set of keys will be generated automatically for
the node, but will not automatically be correlated with any external identity.

#### Federated mode
The aurae deaemon may be correlated with an external identity by signing the
SSH using PKI.


#### Example metadata for a signed SSH key

```
        Signing CA: RSA SHA256:zw3paTCfI3WFo9TfGuOZ75m0cQUK4g9MrwJZkrnwzR8 (using rsa-sha2-512)
        Key ID: "certid"
        Serial: 0
        Valid: forever
        Principals: (none)
        Critical Options: (none)
        Extensions:
                permit-X11-forwarding
                permit-agent-forwarding
                permit-port-forwarding
                permit-pty
                permit-user-rc
```

### Outcomes

The outcome of this will allow for:
* An operator to authenticate themself to a node.
* A node to authenticate itself to an operator.
* A node may be registered to an OIDC identity, provable to any observer.

The outcome of **feature** will unlock the ability for an operator to operate
an auraed instance.

For OpenSSH:
```
sshd_config:

TrustedUserCAKeys
HostKey
HostCertificate

known_hosts:
@cert-authority
```

### Goals

 - Implement SSH Certificate authentication in auraed.

### Decisions

 - Aurae Daemon will use SSH Certificate Signing for all management
   authentication
 - An initial bootstrap may be used to establish SSH Certificate Signing
   when running in detached mode.

### Notes

* At time of writing, it is not clear which entities
  will be observers capable of validating an OIDC identity.

### Authors

 - [@kris-nova](https://github.com/kris-nova)
 - [@Tani](https://github.com/taniwha3)
